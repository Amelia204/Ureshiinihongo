<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ureshii Nihongo - Belajar Bahasa Jepang</title>
    <!-- Tailwind CSS untuk Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Canvas Confetti untuk efek kembang api -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #f1f5f9; /* slate-100 */
            overflow-x: hidden;
        }

        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .perspective-1000 { perspective: 1000px; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .shadow-neon-blue { box-shadow: 0 0 30px rgba(37, 99, 235, 0.4); }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 20px; border: 2px solid #020617; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center relative">

    <!-- Container Utama Aplikasi -->
    <div id="app" class="w-full flex justify-center p-4"></div>

    <!-- Container Chat AI -->
    <div id="ai-chat-container"></div>

    <!-- Modal Tutorial -->
    <div id="tutorial-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md">
        <div class="bg-gray-900 border-2 border-blue-500/50 rounded-[2.5rem] w-full max-w-lg overflow-hidden shadow-2xl">
            <div class="bg-blue-600 p-6 flex items-center gap-3">
                <i data-lucide="help-circle" class="text-white w-8 h-8"></i>
                <h2 class="text-2xl font-black text-white uppercase italic tracking-tight">Cara Belajar di Sini</h2>
            </div>
            <div class="p-8 space-y-8 overflow-y-auto max-h-[60vh] custom-scrollbar text-left">
                <section>
                    <h3 class="text-blue-400 font-black text-lg uppercase flex items-center gap-2 mb-2 italic">
                        <span class="bg-blue-500/20 text-blue-400 w-8 h-8 rounded-full flex items-center justify-center not-italic">1</span> Mulai dengan Flashcard
                    </h3>
                    <div class="pl-10 text-gray-300 space-y-2 text-sm">
                        <p class="font-bold text-white leading-tight">Belum hafal kosakata? Jangan khawatir!</p>
                        <ul class="list-disc list-inside">
                            <li>Pilih kategori kosakata.</li>
                            <li>Klik fitur <span class="text-blue-400 font-bold uppercase text-white">Flashcard</span>.</li>
                            <li>Ketuk kartu untuk melihat arti, dan dengarkan suaranya.</li>
                        </ul>
                    </div>
                </section>
                <section>
                    <h3 class="text-purple-400 font-black text-lg uppercase flex items-center gap-2 mb-2 italic">
                        <span class="bg-purple-500/20 text-purple-400 w-8 h-8 rounded-full flex items-center justify-center not-italic">2</span> Uji Kemampuanmu
                    </h3>
                    <div class="pl-10 text-gray-300">
                        <p class="text-sm leading-relaxed text-white">Sudah merasa faham? Yuk, tes ingatanmu dengan mengerjakan <span class="text-purple-400 font-bold uppercase text-white">Kuis</span> 10 soal acak.</p>
                    </div>
                </section>
                <section>
                    <h3 class="text-yellow-400 font-black text-lg uppercase flex items-center gap-2 mb-2 italic">
                        <span class="bg-yellow-500/20 text-yellow-400 w-8 h-8 rounded-full flex items-center justify-center not-italic">3</span> Bingung? Tanya Sensei AI
                    </h3>
                    <div class="pl-10 text-gray-300">
                        <p class="text-sm leading-relaxed text-white">Ketuk ikon <span class="text-blue-500 font-bold uppercase text-blue-400">Pesan</span> di pojok kanan bawah jika bingung materi!</p>
                    </div>
                </section>
            </div>
            <div class="p-6 bg-gray-800/50 border-t border-white/5">
                <button onclick="closeTutorial()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-white shadow-neon-blue hover:bg-blue-500 transition-all flex items-center justify-center gap-2 uppercase tracking-widest">
                    <i data-lucide="check" class="w-5 h-5"></i> Paham & Lanjutkan
                </button>
            </div>
        </div>
    </div>

<script>
// --- KONFIGURASI AI ---
const apiKey = ""; 

async function fetchAIResponse(userQuery, chatHistory) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const systemPrompt = "Anda adalah 'Sensei AI' di aplikasi Ureshii Nihongo. Bantu pembelajar memahami kosakata JLPT N5. Jawab dalam Bahasa Indonesia yang ramah, singkat, dan beri contoh jika perlu. Fokus hanya pada materi bahasa Jepang.";
    
    const contents = [
        ...chatHistory.map(msg => ({
            role: msg.role === 'user' ? 'user' : 'model',
            parts: [{ text: msg.text }]
        })),
        { role: "user", parts: [{ text: userQuery }] }
    ];

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: systemPrompt }] } })
        });
        const result = await response.json();
        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, Sensei sedang istirahat. Tanya lagi nanti ya!";
    } catch (err) {
        return "Koneksi terputus. Pastikan internetmu aktif!";
    }
}

// --- UTILITAS ---
const speakJapanese = (text) => {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ja-JP';
        utterance.rate = 0.85;
        window.speechSynthesis.speak(utterance);
    }
};

function shuffleArray(array) {
    if (!array || !Array.isArray(array)) return [];
    const newArr = [...array];
    for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
    }
    return newArr;
}

// --- DATABASE KOSAKATA ---
const VOCAB_DATA = {
  'Percakapan Dasar': {
    'salam, sapaan, dan ungkapan': [
      { word: 'おはよう', translation: 'Selamat pagi (frank)', example: 'おはよう、ともだち。', exTrans: 'Selamat pagi, teman.' },
      { word: 'おはようございます', translation: 'Selamat pagi', example: 'せんせい、おはようございます。', exTrans: 'Selamat pagi, Guru.' },
      { word: 'こんにちは', translation: 'Selamat siang / Halo', example: 'みなさん、こんにちは。', exTrans: 'Halo semuanya.' },
      { word: 'こんばんは', translation: 'Selamat malam', example: 'こんばんは、おとうさん。', exTrans: 'Selamat malam, Ayah.' },
      { word: 'おやすみなさい', translation: 'Selamat tidur', example: 'もうねます、おやすみなさい。', exTrans: 'Sudah mau tidur, selamat tidur.' },
      { word: 'さようなら', translation: 'Sampai jumpa lagi', example: 'さようなら、またいつか。', exTrans: 'Sampai jumpa lagi suatu saat nanti.' },
      { word: 'じゃあ、また', translation: 'Sampai ketemu lagi', example: 'じゃあ、またあとで。', exTrans: 'Sampai ketemu lagi nanti.' },
      { word: 'いってきます', translation: 'Saya berangkat ya', example: 'がっこうへいってきます。', exTrans: 'Saya berangkat ke sekolah ya.' },
      { word: 'ただいま', translation: 'Saya sudah pulang', example: 'ただいま、おなかがすいた。', exTrans: 'Saya sudah pulang, lapar nih.' },
      { word: 'おかえり', translation: 'Selamat pulang', example: 'おかえりなさい、おにいさん。', exTrans: 'Selamat pulang, Kak.' },
      { word: 'いただきます', translation: 'Selamat makan', example: 'おいしそう！いただきます。', exTrans: 'Kelihatannya enak! Selamat makan.' },
      { word: 'ごちそうさま', translation: 'Terima kasih atas hidangannya', example: 'おなかいっぱいです。ごちそうさまでした。', exTrans: 'Sudah kenyang. Terima kasih atas hidangannya.' },
      { word: 'はじめまして', translation: 'Salam kenal', example: 'はじめまして、わたしはありです。', exTrans: 'Salam kenal, saya adalah Ari.' },
      { word: 'ありがとう', translation: 'Terima kasih', example: 'てつだってくれて、ありがとう。', exTrans: 'Terima kasih sudah membantu.' },
      { word: 'すみません', translation: 'Maaf / Permisi', example: 'すみません、いまなんじですか。', exTrans: 'Permisi, sekarang jam berapa?' },
      { word: 'ごめんなさい', translation: 'Minta maaf', example: 'おそくなって、ごめんなさい。', exTrans: 'Maaf karena terlambat.' },
      { word: 'おげんきですか', translation: 'Apa kabar?', example: 'おひさしぶりです、おげんきですか。', exTrans: 'Sudah lama tidak bertemu, apa kabar?' }
    ],
  },
  'Kata Benda': {
    'angka': [
      { word: 'いち', translation: 'Satu', example: 'いっちばん。', exTrans: 'Nomor satu.' },
      { word: 'に', translation: 'Dua', example: 'にじ。', exTrans: 'Jam dua.' },
      { word: 'さん', translation: 'Tiga', example: 'さんげつ。', exTrans: 'Tiga bulan.' },
      { word: 'よん', translation: 'Empat', example: 'よにん。', exTrans: 'Empat orang.' },
      { word: 'ご', translation: 'Lima', example: 'ごえん。', exTrans: 'Lima yen.' },
      { word: 'ろく', translation: 'Enam', example: 'ろくじ。', exTrans: 'Jam enam.' },
      { word: 'なな', translation: 'Tujuh', example: 'ななさい。', exTrans: 'Tujuh tahun.' },
      { word: 'はち', translation: 'Delapan', example: 'はちじ。', exTrans: 'Jam delapan.' },
      { word: 'きゅう', translation: 'Sembilan', example: 'くじ。', exTrans: 'Jam sembilan.' },
      { word: 'じゅう', translation: 'Sepuluh', example: 'じゅうえん。', exTrans: 'Sepuluh yen.' }
    ],
    'Makanan dan Minuman': [
      { word: 'たべもの', translation: 'makanan', example: 'たべものがすき。', exTrans: 'Suka makanan.' },
      { word: 'にく', translation: 'daging', example: 'にくをたべます。', exTrans: 'Makan daging.' },
      { word: 'やさい', translation: 'sayur-sayuran', example: 'やさいをたべてね。', exTrans: 'Makan sayur ya.' },
      { word: 'くだもの', translation: 'buah-buahan', example: 'くだものがほしい。', exTrans: 'Ingin buah-buahan.' },
      { word: 'みず', translation: 'air putih', example: 'みずをください。', exTrans: 'Minta air putih.' },
      { word: 'おちゃ', translation: 'teh hijau', example: 'おちゃをのみましょう。', exTrans: 'Mari minum teh hijau.' }
    ],
    'Sekolah dan Kelas': [
      { word: 'がっこう', translation: 'sekolah', example: 'がっこうへいきます。', exTrans: 'Pergi ke sekolah.' },
      { word: 'がくせい', translation: 'pelajar', example: 'わたしはがくせいです。', exTrans: 'Saya adalah pelajar.' },
      { word: 'せんせい', translation: 'guru', example: 'やさしいせんせい。', exTrans: 'Guru yang baik hati.' },
      { word: 'ほん', translation: 'buku', example: 'ほんをよむ。', exTrans: 'Membaca buku.' },
      { word: 'えんぴつ', translation: 'pensil', example: 'えんぴつでかきます。', exTrans: 'Menulis dengan pensil.' }
    ]
  },
  'Kata Sifat': {
    'Sifat-i': [
      { word: 'おおきい', translation: 'Besar', example: 'おおきいいえ。', exTrans: 'Rumah yang besar.' },
      { word: 'ちいさい', translation: 'Kecil', example: 'ちいさいくるま。', exTrans: 'Mobil yang kecil.' },
      { word: 'あたらしい', translation: 'Baru', example: 'あたらしいかばん。', exTrans: 'Tas yang baru.' },
      { word: 'ふるい', translation: 'Lama / tua', example: 'ふるいじしょ。', exTrans: 'Kamus lama.' },
      { word: 'おいしい', translation: 'Enak', example: 'このおかしはおいしい。', exTrans: 'Kue ini enak.' }
    ],
    'Sifat-na': [
      { word: 'きれい', translation: 'Cantik, bersih', example: 'きれいなはな。', exTrans: 'Bunga yang cantik.' },
      { word: 'しんせつ', translation: 'Baik hati', example: 'しんせつなひと。', exTrans: 'Orang yang baik hati.' },
      { word: 'べんり', translation: 'Praktis', example: 'べんりなスマホ。', exTrans: 'Smartphone yang praktis.' }
    ]
  },
  'Kata Kerja': {
    'Aktivitas': [
      { word: 'たべる', translation: 'makan', example: 'ごはんをたべる。', exTrans: 'Makan nasi.' },
      { word: 'のむ', translation: 'minum', example: 'みずをのむ。', exTrans: 'Minum air.' },
      { word: 'いく', translation: 'pergi', example: 'がっこうへいく。', exTrans: 'Pergi ke sekolah.' },
      { word: 'くる', translation: 'datang', example: 'ともだちがくる。', exTrans: 'Teman datang.' },
      { word: 'みる', translation: 'melihat', example: 'えいがをみる。', exTrans: 'Menonton film.' },
      { word: 'する', translation: 'melakukan', example: 'べんきょうをする。', exTrans: 'Melakukan pelajaran.' }
    ]
  }
};

let ALL_GAME_VOCAB = [];
Object.values(VOCAB_DATA).forEach(cat => {
  Object.values(cat).forEach(sub => {
    if (Array.isArray(sub)) ALL_GAME_VOCAB.push(...sub);
  });
});

// --- STATE APLIKASI ---
let state = {
    page: 'home',
    selectedCat: null,
    currentDeck: [],
    flippedStates: {},
    flashcardIdx: 0,
    quizState: { questions: [], idx: 0, score: 0, lives: 3, history: [], finished: false },
    matchState: { level: 1, cards: [], flipped: [], solved: [], previewing: false, timeoutId: null },
    speedState: { target: null, options: [], timer: 8, score: 0, isOver: false, intervalId: null },
    scrambleState: { target: null, scrambled: [], selected: [], score: 0, lives: 3, isFinished: false },
    chatState: { isOpen: false, isTyping: false, messages: [{ role: 'model', text: 'Halo! Saya Sensei AI. Ada kosakata yang membingungkan? Tanya saja saya ya!' }] }
};

// --- RENDER ENGINE SEDERHANA ---
const appDiv = document.getElementById('app');

function navigate(pageStr) {
    state.page = pageStr;
    // Clear any game intervals
    if(state.speedState.intervalId) clearInterval(state.speedState.intervalId);
    if(state.matchState.timeoutId) clearTimeout(state.matchState.timeoutId);
    renderApp();
}

function getVocabFromPath(path) {
    if (!path) return null;
    const parts = path.split(' > ');
    let current = VOCAB_DATA;
    for (const part of parts) {
        if (!current || !current[part]) return null;
        current = current[part];
    }
    return current;
}

function showTutorialModal() {
    document.getElementById('tutorial-modal').classList.remove('hidden');
}

function closeTutorial() {
    document.getElementById('tutorial-modal').classList.add('hidden');
}

// --- FUNGSI RENDER VIEW ---
function renderHome() {
    return `
        <div class="text-center text-white w-full">
            <h1 class="text-6xl md:text-8xl font-black italic mb-12 tracking-tighter uppercase leading-none text-center w-full">
                URESHII <span class="text-blue-500 block text-2xl md:text-3xl not-italic tracking-[0.5em] font-bold mt-4 uppercase text-center w-full">Nihongo</span>
            </h1>
            <div class="flex flex-col gap-4 items-center">
                <button class="bg-blue-600 px-16 py-5 rounded-full font-black text-2xl shadow-neon-blue hover:bg-blue-500 transition-all border-b-8 border-blue-800 active:border-b-0 active:translate-y-1" 
                        onclick="navigate('categories'); showTutorialModal();">
                    MULAI BELAJAR
                </button>
                <button class="flex items-center gap-2 text-blue-400 font-bold hover:text-blue-300 transition-colors bg-gray-800/50 px-6 py-2 rounded-full border border-blue-500/20" 
                        onclick="navigate('about')">
                    <i data-lucide="info" class="w-4 h-4"></i> About Me
                </button>
            </div>
        </div>
    `;
}

function renderAbout() {
    return `
        <div class="w-full max-w-4xl p-10 bg-gray-900/80 backdrop-blur-xl rounded-[3rem] border-2 border-blue-500/30 shadow-2xl overflow-y-auto max-h-[85vh] text-center">
            <button onclick="navigate('home')" class="mb-8 p-3 bg-gray-800 rounded-full hover:bg-gray-700 shadow-xl inline-flex items-center justify-center">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <div class="space-y-10">
                <section class="text-center">
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-neon-blue">
                        <i data-lucide="user" class="w-12 h-12 text-white"></i>
                    </div>
                    <h2 class="text-3xl font-black text-white mb-2 uppercase">Halo! Selamat datang di platform ini.</h2>
                    <p class="text-lg leading-relaxed text-center">
                        Saya <span class="text-blue-400 font-bold">Amelia Rafika Prameswari Basuki</span> (NIM: 2302422068), seorang mahasiswa yang memiliki dedikasi dalam dunia pendidikan. Website ini adalah prototipe media pembelajaran digital untuk pemelajar bahasa Jepang pemula.
                    </p>
                </section>
                <hr class="border-white/10" />
                <section class="text-left">
                    <h3 class="text-2xl font-black text-blue-400 mb-4 flex items-center gap-3 uppercase italic">
                        <i data-lucide="target" class="w-6 h-6"></i> Misi dan Tujuan
                    </h3>
                    <p class="leading-relaxed">Website ini dikembangkan untuk mengeksplorasi efektivitas media interaktif dalam mempermudah penguasaan kosa kata JLPT N5 secara digital.</p>
                </section>
            </div>
        </div>
    `;
}

function renderCategories() {
    let catHTML = Object.keys(VOCAB_DATA).map(cat => `
        <button class="bg-gray-800 p-8 rounded-3xl border-b-4 border-blue-700 hover:bg-gray-700 flex justify-between items-center transition-all shadow-2xl group text-left" 
                onclick="state.selectedCat = '${cat}'; navigate('subcategories');">
            <span class="text-2xl font-black uppercase">${cat}</span>
            <i data-lucide="chevron-right" class="text-blue-500 group-hover:translate-x-2 transition-transform w-6 h-6"></i>
        </button>
    `).join('');

    return `
        <div class="w-full max-w-4xl p-6 text-center relative">
            <div class="flex items-center gap-4 mb-2">
                <button onclick="navigate('home')" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 shadow-xl transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-4xl font-black uppercase tracking-tight text-center w-full">Kategori Materi</h2>
            </div>
            <p class="text-blue-400 font-black mb-8 animate-pulse-slow text-sm uppercase tracking-widest text-center w-full">Pilih kategori materi yang ingin kamu pelajari di bawah ini.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-14">
                ${catHTML}
            </div>
            
            <div class="bg-gradient-to-br from-indigo-900 to-purple-950 p-8 rounded-[3rem] border-2 border-white/10 shadow-2xl text-center">
                <h3 class="text-2xl font-black text-yellow-400 mb-8 flex items-center justify-center gap-3 italic uppercase">
                    <i data-lucide="gamepad-2" class="w-8 h-8"></i> Main Game Seru!
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button class="p-5 rounded-2xl font-black shadow-lg hover:scale-105 transition-all bg-blue-600 text-white" onclick="startMatchGame()">Memory Match</button>
                    <button class="p-5 rounded-2xl font-black shadow-lg hover:scale-105 transition-all bg-pink-600 text-white" onclick="startSpeedGame()">Speed Translator</button>
                    <button class="p-5 rounded-2xl font-black shadow-lg hover:scale-105 transition-all bg-yellow-500 text-black" onclick="startScrambleGame()">Word Scramble</button>
                </div>
            </div>
        </div>
    `;
}

function renderSubcategories() {
    if(!state.selectedCat) return '';
    let subsHTML = Object.keys(VOCAB_DATA[state.selectedCat]).map(sub => `
        <button class="w-full bg-gray-800 p-6 rounded-[2rem] border-l-8 border-blue-500 font-black text-xl hover:bg-blue-600 transition-all flex justify-between items-center text-left shadow-xl" 
                onclick="state.selectedCat = '${state.selectedCat} > ${sub}'; navigate('modeSelect');">
            ${sub}
            <i data-lucide="book-open" class="opacity-20 w-6 h-6"></i>
        </button>
    `).join('');

    return `
        <div class="w-full max-w-md p-6 text-center">
            <div class="flex items-center gap-5 mb-2">
                <button onclick="state.selectedCat = null; navigate('categories');" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 shadow-xl">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-3xl font-black text-blue-400 uppercase tracking-widest leading-tight text-center w-full">${state.selectedCat}</h2>
            </div>
            <p class="text-blue-400 font-black mb-10 animate-pulse-slow text-xs uppercase tracking-widest text-center w-full">Pilih salah satu kategori yang akan kamu pelajari.</p>
            <div class="space-y-4">
                ${subsHTML}
            </div>
        </div>
    `;
}

function renderModeSelect() {
    let title = state.selectedCat.split(' > ').pop();
    return `
        <div class="text-center p-14 bg-gray-800 rounded-[3rem] border-4 border-blue-600 shadow-2xl max-w-sm relative">
            <button onclick="state.selectedCat = state.selectedCat.split(' > ')[0]; navigate('subcategories');" class="absolute top-6 left-6 p-2 bg-gray-700 rounded-full">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h2 class="text-4xl font-black mb-2 uppercase italic text-center w-full">${title}</h2>
            <p class="text-blue-400 font-black mb-10 text-xs uppercase tracking-widest text-center w-full">Pilih mode belajar kamu.</p>
            
            <div class="flex flex-col gap-5">
                <button class="bg-blue-600 py-5 px-10 rounded-2xl font-black text-xl shadow-neon-blue hover:bg-blue-500 inline-flex justify-center items-center gap-2" 
                        onclick="navigate('vocabList')">
                    <i data-lucide="list" class="w-6 h-6"></i> Daftar Kosakata
                </button>
                <button class="bg-purple-600 py-5 px-10 rounded-2xl font-black text-xl shadow-lg hover:bg-purple-500 inline-flex justify-center items-center gap-2" 
                        onclick="initQuiz()">
                    <i data-lucide="brain" class="w-6 h-6"></i> Kuis
                </button>
            </div>
            <button class="mt-10 text-gray-500 font-black uppercase text-sm tracking-widest" onclick="state.selectedCat = state.selectedCat.split(' > ')[0]; navigate('subcategories');">Kembali Ke Sub-Kategori</button>
        </div>
    `;
}

function initFlashcards() {
    const vocab = getVocabFromPath(state.selectedCat);
    if(vocab) {
        state.currentDeck = shuffleArray(vocab);
        state.flippedStates = {};
        state.flashcardIdx = 0;
        navigate('flashcards');
    }
}

function toggleFlip(index) {
    state.flippedStates[index] = !state.flippedStates[index];
    renderApp();
}

function nextFlashcard() {
    if (state.flashcardIdx < state.currentDeck.length - 1) {
        state.flashcardIdx++;
        renderApp();
    }
}

function prevFlashcard() {
    if (state.flashcardIdx > 0) {
        state.flashcardIdx--;
        renderApp();
    }
}

function renderVocabList() {
    const vocab = getVocabFromPath(state.selectedCat);
    if (!vocab) return '';
    let title = state.selectedCat.split(' > ').pop();

    let listHTML = vocab.map(v => `
        <div class="bg-gray-800 p-5 rounded-2xl border-l-4 border-blue-500 mb-4 text-left shadow-lg flex justify-between items-center hover:bg-gray-700 transition-colors">
            <div>
                <p class="text-3xl font-black text-blue-300 mb-1 cursor-pointer hover:text-white transition-colors" onclick="speakJapanese('${v.word.replace(/'/g, "\\'")}')">${v.word}</p>
                <p class="text-lg font-bold text-white mb-2">${v.translation}</p>
                ${v.example ? `
                    <div class="text-sm text-gray-400 border-t border-white/10 pt-2 mt-2">
                        <p class="text-blue-200 font-bold mb-1">${v.example}</p>
                        <p class="italic text-xs">"${v.exTrans}"</p>
                    </div>
                ` : ''}
            </div>
            <button onclick="speakJapanese('${v.word.replace(/'/g, "\\'")}')" class="p-4 bg-blue-600/20 text-blue-400 rounded-full hover:bg-blue-600 hover:text-white transition-all shrink-0 ml-4 active:scale-95">
                <i data-lucide="volume-2" class="w-6 h-6"></i>
            </button>
        </div>
    `).join('');

    return `
        <div class="w-full max-w-2xl p-4 text-center">
            <div class="flex justify-between items-center mb-6 px-2">
                <button onclick="navigate('modeSelect')" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors shadow-xl">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-black text-blue-400 uppercase italic truncate px-4">${title}</h2>
                <div class="w-12"></div>
            </div>

            <p class="text-gray-400 mb-6 font-black text-sm uppercase tracking-widest">Daftar Kosakata</p>

            <div class="max-h-[55vh] overflow-y-auto custom-scrollbar pr-2 mb-8 text-left">
                ${listHTML}
            </div>

            <button class="bg-blue-600 w-full py-5 rounded-3xl font-black text-lg shadow-neon-blue hover:bg-blue-500 flex justify-center items-center gap-3 uppercase tracking-widest transition-all active:scale-95" onclick="initFlashcards()">
                <i data-lucide="layers" class="w-6 h-6"></i> Latihan dengan Flashcard
            </button>
        </div>
    `;
}

function renderFlashcards() {
    let title = state.selectedCat.split(' > ').pop();
    let idx = state.flashcardIdx;
    let v = state.currentDeck[idx];
    let isFlipped = !!state.flippedStates[idx];
    let rotationClass = isFlipped ? 'rotate-y-180' : '';
    
    let exampleHTML = v.example ? `
        <div class="w-full bg-black/30 p-4 rounded-xl border border-white/5 mt-4 text-center">
            <p class="text-sm font-bold text-blue-100 leading-tight mb-2">${v.example}</p>
            <p class="text-xs italic text-gray-300 leading-tight">"${v.exTrans}"</p>
        </div>
    ` : '';

    let cardHTML = `
        <div class="w-full max-w-sm aspect-[3/4] cursor-pointer perspective-1000 mx-auto" onclick="toggleFlip(${idx})">
            <div class="relative w-full h-full transition-transform duration-500 transform-style-3d shadow-neon-blue rounded-[2.5rem] ${rotationClass}">
                <!-- Bagian Depan -->
                <div class="absolute inset-0 bg-gray-800 rounded-[2.5rem] backface-hidden flex flex-col items-center justify-center p-6 text-center font-bold border-4 border-blue-500">
                    <p class="text-blue-300 font-black text-5xl mb-6 tracking-tight leading-tight break-words px-2">${v.word}</p>
                    <button onclick="event.stopPropagation(); speakJapanese('${v.word.replace(/'/g, "\\'")}');" class="mt-4 p-4 rounded-full bg-blue-600/20 hover:bg-blue-600 transition-all text-white active:scale-95">
                        <i data-lucide="volume-2" class="w-8 h-8"></i>
                    </button>
                </div>
                <!-- Bagian Belakang -->
                <div class="absolute inset-0 bg-blue-900 rounded-[2.5rem] backface-hidden flex flex-col items-center justify-center p-6 text-center border-4 border-blue-400 overflow-hidden rotate-y-180">
                    <p class="text-xs font-black uppercase text-blue-300 mb-2 w-full text-center tracking-widest">Arti</p>
                    <p class="text-3xl font-black leading-tight w-full mb-4 text-center text-white">${v.translation}</p>
                    ${exampleHTML}
                </div>
            </div>
        </div>
    `;

    return `
        <div class="w-full max-w-2xl p-4 flex flex-col items-center text-center">
            <div class="w-full flex justify-between items-center mb-6">
                <button onclick="navigate('vocabList')" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-black text-blue-400 uppercase italic truncate px-4">${title}</h2>
                <div class="w-12"></div> <!-- Spacer -->
            </div>
            
            <p class="text-blue-400 font-black mb-4 animate-pulse-slow text-xs uppercase w-full text-center">Ketuk flashcard untuk melihat arti.</p>
            
            <div class="text-gray-400 font-black tracking-widest text-sm mb-6 bg-gray-800/50 px-6 py-2 rounded-full border border-white/5">
                ${idx + 1} / ${state.currentDeck.length}
            </div>

            ${cardHTML}
            
            <div class="flex items-center gap-8 mt-12">
                <button onclick="prevFlashcard()" class="p-4 bg-gray-800 text-blue-400 rounded-full hover:bg-blue-600 hover:text-white transition-all disabled:opacity-20 disabled:cursor-not-allowed disabled:hover:bg-gray-800 disabled:hover:text-blue-400 shadow-xl" ${idx === 0 ? 'disabled' : ''}>
                    <i data-lucide="chevron-left" class="w-8 h-8"></i>
                </button>
                <button onclick="nextFlashcard()" class="p-4 bg-gray-800 text-blue-400 rounded-full hover:bg-blue-600 hover:text-white transition-all disabled:opacity-20 disabled:cursor-not-allowed disabled:hover:bg-gray-800 disabled:hover:text-blue-400 shadow-xl" ${idx === state.currentDeck.length - 1 ? 'disabled' : ''}>
                    <i data-lucide="chevron-right" class="w-8 h-8"></i>
                </button>
            </div>

            <button class="mt-12 text-gray-500 font-black uppercase text-sm tracking-widest hover:text-white transition-colors" onclick="navigate('vocabList')">Selesai Belajar</button>
        </div>
    `;
}

// --- QUIZ LOGIC ---
function initQuiz() {
    const vocab = getVocabFromPath(state.selectedCat);
    if (!Array.isArray(vocab) || vocab.length < 4) {
        alert("Materi tidak cukup untuk kuis. (Minimal 4 kata)");
        return;
    }
    const shuffledFullPool = shuffleArray([...vocab]);
    const selectedVocab = shuffledFullPool.slice(0, 10);
    const qs = selectedVocab.map(v => {
        const others = vocab.filter(x => x.translation !== v.translation);
        return { 
            word: v.word, 
            question: v.word, 
            answer: v.translation, 
            options: shuffleArray([...shuffleArray(others).slice(0, 3).map(o => o.translation), v.translation]) 
        };
    });
    
    state.quizState = { questions: qs, idx: 0, score: 0, lives: 3, history: [], finished: false };
    navigate('quiz');
}

function handleQuizAnswer(selectedAns) {
    let qState = state.quizState;
    if(qState.finished) return;

    const q = qState.questions[qState.idx];
    const isCorrect = (selectedAns === q.answer);
    
    qState.history.push({ question: q, selectedAnswer: selectedAns, isCorrect: isCorrect });
    
    if (isCorrect) {
        qState.score += 100;
    } else {
        qState.lives = Math.max(0, qState.lives - 1);
    }
    
    // Tunggu sedikit sebelum lanjut
    renderApp(); // Render status (maybe highlight answer, here we just skip to next after delay)
    setTimeout(() => {
        let nextIdx = qState.idx + 1;
        if (qState.lives <= 0 || nextIdx >= qState.questions.length) {
            qState.finished = true;
            if (qState.lives > 0) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else {
            qState.idx = nextIdx;
        }
        renderApp();
    }, 600);
}

function renderQuiz() {
    let qs = state.quizState;
    if (qs.finished) {
        return `
            <div class="bg-gray-800 p-12 rounded-[3rem] border-2 border-blue-500 text-center max-w-sm w-full shadow-2xl">
                <i data-lucide="trophy" class="w-20 h-20 text-yellow-400 mx-auto mb-6"></i>
                <h2 class="text-4xl font-black mb-2 uppercase text-center w-full">KUIS SELESAI</h2>
                <p class="text-6xl font-black text-blue-400 mb-12 text-center w-full">Skor: ${qs.score}</p>
                <div class="flex flex-col gap-4">
                    <button class="bg-blue-600 py-4 rounded-2xl font-black text-lg hover:bg-blue-500" onclick="initQuiz()">Ulang Kuis</button>
                    <button class="bg-gray-700 py-4 rounded-2xl font-black text-lg hover:bg-gray-600" onclick="navigate('review')">Analisis Jawaban</button>
                    <button class="text-gray-500 font-black mt-6" onclick="navigate('modeSelect')">Kembali</button>
                </div>
            </div>
        `;
    }

    let q = qs.questions[qs.idx];
    let heartsHTML = Array(3).fill(0).map((_, i) => `
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="${i < qs.lives ? '#ef4444' : 'transparent'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${i < qs.lives ? 'text-red-500' : 'text-gray-700'}"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
    `).join('');

    let progress = qs.questions.length > 0 ? (qs.idx / qs.questions.length) * 100 : 0;

    let optionsHTML = q.options.map(opt => `
        <button class="bg-gray-700 py-5 px-6 rounded-2xl font-bold transition-all shadow-md hover:bg-gray-600 active:scale-95" 
                onclick="handleQuizAnswer('${opt.replace(/'/g, "\\'")}')">
            ${opt}
        </button>
    `).join('');

    return `
        <div class="w-full max-w-2xl flex flex-col items-center p-4 text-center">
            <div class="flex justify-between w-full mb-8 items-center px-6">
                <button onclick="navigate('modeSelect')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div class="font-black text-blue-400 italic text-2xl uppercase">Skor: ${qs.score}</div>
                <div class="flex gap-1.5 bg-black/30 px-4 py-2 rounded-full border border-white/5">
                    ${heartsHTML}
                </div>
            </div>
            <div class="w-full h-4 bg-gray-800 rounded-full mb-14 overflow-hidden border border-white/5 p-1">
                <div class="h-full bg-blue-500 rounded-full transition-all shadow-neon-blue" style="width: ${progress}%"></div>
            </div>
            
            <div class="flex flex-col items-center w-full">
                <div class="text-center bg-gray-800 text-blue-300 rounded-3xl p-10 w-full max-sm:p-6 max-w-sm mb-10 shadow-lg border-2 border-blue-500 relative transition-transform duration-300 transform scale-100">
                    <p class="text-4xl font-black tracking-tighter cursor-pointer text-white" onclick="speakJapanese('${q.word}')">${q.word}</p>
                    <button onclick="speakJapanese('${q.word}')" class="mt-4 p-3 rounded-full bg-blue-600/20 hover:bg-blue-600 transition-colors mx-auto flex items-center justify-center">
                        <i data-lucide="volume-2" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg">
                    ${optionsHTML}
                </div>
            </div>
        </div>
    `;
}

function renderReview() {
    let qs = state.quizState;
    let listHTML = qs.history.map(item => `
        <div class="p-8 rounded-[2rem] border-l-[12px] bg-gray-800 shadow-2xl ${item.isCorrect ? 'border-green-500' : 'border-red-500'}">
            <div class="flex justify-between items-start mb-5">
                <span class="text-5xl font-black tracking-tighter uppercase text-left w-full cursor-pointer hover:text-blue-300" onclick="speakJapanese('${item.question.word}')">${item.question.word}</span>
                ${item.isCorrect ? '<i data-lucide="check-circle-2" class="w-10 h-10 text-green-500"></i>' : '<i data-lucide="x-circle" class="w-10 h-10 text-red-500"></i>'}
            </div>
            <p class="text-green-400 font-black text-2xl mb-2 italic uppercase text-left">Maksud: ${item.question.answer}</p>
            ${!item.isCorrect ? `<p class="text-red-400 font-black mb-6 text-xl text-left uppercase">Jawaban Anda: ${item.selectedAnswer}</p>` : ''}
        </div>
    `).join('');

    return `
        <div class="w-full max-w-4xl p-6 text-center">
            <div class="w-full flex justify-start mb-8">
                <button onclick="navigate('quiz')" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
            </div>
            <h2 class="text-5xl font-black text-center mb-14 uppercase text-blue-400 w-full">Analisis Belajar</h2>
            <div class="grid gap-6 max-h-[65vh] overflow-y-auto p-4 custom-scrollbar text-left">
                ${listHTML}
            </div>
        </div>
    `;
}

// --- GAME LOGIC ---

function startMatchGame() {
    state.matchState.level = 1;
    initMatchLevel(1);
    navigate('gameMatch');
}

function initMatchLevel(lvl) {
    let ms = state.matchState;
    ms.solved = []; ms.flipped = []; ms.previewing = true;
    const pairCount = lvl === 1 ? 3 : lvl === 2 ? 4 : lvl === 3 ? 6 : 8;
    const selected = shuffleArray(ALL_GAME_VOCAB).slice(0, pairCount);
    const gameCards = [];
    selected.forEach((v, i) => {
        gameCards.push({ id: `a-${i}`, val: v.word, mId: i });
        gameCards.push({ id: `b-${i}`, val: v.translation, mId: i });
    });
    ms.cards = shuffleArray(gameCards);
    renderApp();
    ms.timeoutId = setTimeout(() => {
        state.matchState.previewing = false;
        renderApp();
    }, 2000 + (lvl * 400));
}

function handleMatchCardClick(cardId, mId) {
    let ms = state.matchState;
    if(ms.previewing || ms.flipped.length === 2 || ms.solved.includes(cardId) || ms.flipped.includes(cardId)) return;
    
    ms.flipped.push(cardId);
    renderApp();

    if(ms.flipped.length === 2) {
        let firstCardId = ms.flipped[0];
        let firstCard = ms.cards.find(x => x.id === firstCardId);
        if(firstCard.mId === mId) {
            ms.solved.push(firstCardId, cardId);
            ms.flipped = [];
            renderApp();
        } else {
            ms.timeoutId = setTimeout(() => {
                state.matchState.flipped = [];
                renderApp();
            }, 800);
        }
    }
}

function renderGameMatch() {
    let ms = state.matchState;
    let cardsHTML = ms.cards.map(c => {
        const isOpen = ms.previewing || ms.flipped.includes(c.id) || ms.solved.includes(c.id);
        return `
            <div class="w-[calc(33%-12px)] sm:w-[calc(25%-12px)] aspect-square relative perspective-1000 cursor-pointer" onclick="handleMatchCardClick('${c.id}', ${c.mId})">
                <div class="w-full h-full transition-transform duration-500 transform-style-3d relative ${isOpen ? 'rotate-y-180' : ''}">
                    <!-- Belakang Kartu (Tertutup) -->
                    <div class="absolute inset-0 bg-gray-800 rounded-2xl border-2 border-gray-700 flex items-center justify-center backface-hidden shadow-2xl">
                        <i data-lucide="gamepad-2" class="opacity-10 w-12 h-12 text-white"></i>
                    </div>
                    <!-- Depan Kartu (Terbuka) -->
                    <div class="absolute inset-0 bg-blue-600 rounded-2xl border-2 border-blue-400 flex items-center justify-center p-2 text-center rotate-y-180 backface-hidden shadow-neon-blue">
                        <span class="text-[10px] sm:text-xs font-black leading-tight uppercase text-white break-words">${c.val}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    let winHTML = (ms.solved.length === ms.cards.length && ms.cards.length > 0) ? `
        <div class="mt-12 text-center bg-gray-800 p-8 rounded-3xl border-2 border-yellow-500 shadow-2xl">
            <i data-lucide="trophy" class="w-12 h-12 text-yellow-400 mx-auto mb-3"></i>
            <h3 class="text-2xl font-black mb-6 uppercase">Luar Biasa! Berhasil!</h3>
            <button class="bg-green-600 px-12 py-3 rounded-full font-black shadow-lg hover:scale-105 transition-all" onclick="initMatchLevel(${ms.level + 1}); state.matchState.level++;">Level Berikutnya</button>
        </div>
    ` : '';

    return `
        <div class="flex flex-col items-center w-full max-w-4xl p-4 text-center">
            <div class="flex justify-between w-full mb-8 items-center px-4">
                <button onclick="navigate('categories')" class="p-3 bg-gray-800 rounded-full hover:bg-gray-700 shadow-xl transition-all">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-3xl font-black text-blue-400 italic uppercase">Memory Match</h2>
            </div>
            ${ms.previewing ? '<div class="mb-6 text-yellow-400 font-black animate-pulse-slow flex items-center justify-center gap-3 text-lg uppercase tracking-widest"><i data-lucide="eye" class="w-6 h-6"></i> Hafalkan Posisi Kartu!</div>' : ''}
            <div class="flex flex-wrap justify-center gap-3 w-full max-w-3xl mx-auto overflow-y-auto max-h-[60vh] p-2 custom-scrollbar">
                ${cardsHTML}
            </div>
            ${winHTML}
        </div>
    `;
}

function startSpeedGame() {
    state.speedState.score = 0;
    state.speedState.isOver = false;
    nextSpeedRound();
    navigate('gameSpeed');
}

function nextSpeedRound() {
    let ss = state.speedState;
    if(ss.intervalId) clearInterval(ss.intervalId);
    
    const correct = ALL_GAME_VOCAB[Math.floor(Math.random() * ALL_GAME_VOCAB.length)];
    const others = shuffleArray(ALL_GAME_VOCAB.filter(v => v.translation !== correct.translation)).slice(0, 3);
    
    ss.target = correct;
    ss.options = shuffleArray([...others.map(o => o.translation), correct.translation]);
    ss.timer = 8;
    
    ss.intervalId = setInterval(() => {
        state.speedState.timer--;
        if(state.speedState.timer <= 0) {
            clearInterval(state.speedState.intervalId);
            state.speedState.isOver = true;
        }
        renderApp();
    }, 1000);
}

function handleSpeedSelect(ans) {
    let ss = state.speedState;
    if(ans === ss.target.translation) {
        ss.score += 10;
        nextSpeedRound();
    } else {
        clearInterval(ss.intervalId);
        ss.isOver = true;
    }
    renderApp();
}

function renderGameSpeed() {
    let ss = state.speedState;
    if(ss.isOver) {
        return `
            <div class="flex flex-col items-center w-full max-w-lg p-8 bg-gray-800 rounded-3xl border-2 border-pink-500 shadow-2xl text-center">
                <div class="text-center py-10">
                    <i data-lucide="x-circle" class="w-16 h-16 text-red-500 mx-auto mb-6"></i>
                    <h2 class="text-4xl font-black mb-2 uppercase tracking-tighter w-full text-center">WAKTU HABIS!</h2>
                    <p class="text-gray-400 mb-10 font-bold text-2xl w-full text-center">Skor Akhir: ${ss.score}</p>
                    <button class="bg-pink-600 px-12 py-4 rounded-full font-black mb-4 w-full shadow-lg hover:bg-pink-500 transition-colors" onclick="startSpeedGame()">Main Lagi</button>
                    <button class="text-gray-500 font-bold mt-4" onclick="navigate('categories')">Keluar</button>
                </div>
            </div>
        `;
    }

    let optionsHTML = ss.options.map(opt => `
        <button class="bg-gray-700 py-5 rounded-2xl font-bold hover:bg-pink-600 transition-all border border-white/5 text-lg shadow-lg" onclick="handleSpeedSelect('${opt.replace(/'/g, "\\'")}')">${opt}</button>
    `).join('');

    return `
        <div class="flex flex-col items-center w-full max-w-lg p-8 bg-gray-800 rounded-3xl border-2 border-pink-500 shadow-2xl text-center">
            <div class="flex justify-between w-full mb-10 items-center px-2">
                <div class="font-black text-3xl flex items-center gap-2 ${ss.timer < 4 ? 'text-red-500 animate-pulse' : 'text-pink-400'}">
                    <i data-lucide="timer" class="w-7 h-7"></i> ${ss.timer}s
                </div>
                <div class="font-black text-2xl uppercase">Skor: ${ss.score}</div>
            </div>
            <div class="text-6xl font-black mb-14 uppercase tracking-tighter w-full text-center">${ss.target?.word}</div>
            <div class="grid grid-cols-1 gap-4 w-full">
                ${optionsHTML}
            </div>
        </div>
    `;
}

function startScrambleGame() {
    state.scrambleState = { target: null, scrambled: [], selected: [], score: 0, lives: 3, isFinished: false };
    initScrambleRound();
    navigate('gameScramble');
}

function initScrambleRound() {
    let scr = state.scrambleState;
    const validItems = ALL_GAME_VOCAB.filter(v => v.word.length > 1);
    const item = validItems[Math.floor(Math.random() * validItems.length)];
    if(!item) return navigate('categories');
    
    scr.target = item;
    scr.scrambled = shuffleArray(item.word.split(''));
    scr.selected = [];
    renderApp();
}

function handleScrambleChar(char, originalIndex) {
    let scr = state.scrambleState;
    if(scr.selected.length >= scr.target.word.length) return;
    
    scr.selected.push({ char, idx: originalIndex });
    
    if(scr.selected.length === scr.target.word.length) {
        const result = scr.selected.map(s => s.char).join('');
        if(result === scr.target.word) {
            scr.score += 20;
            setTimeout(initScrambleRound, 800);
        } else {
            if(scr.lives > 1) {
                scr.lives -= 1;
                setTimeout(initScrambleRound, 1000);
            } else {
                scr.lives = 0;
                scr.isFinished = true;
            }
        }
    }
    renderApp();
}

function handleRemoveScrambleChar(indexToRemove) {
    state.scrambleState.selected.splice(indexToRemove, 1);
    renderApp();
}

function renderGameScramble() {
    let scr = state.scrambleState;
    if(scr.isFinished) {
        return `
            <div class="text-center p-12 bg-gray-800 rounded-3xl border-4 border-yellow-600 shadow-2xl max-w-sm w-full">
                <i data-lucide="trophy" class="w-16 h-16 text-yellow-400 mx-auto mb-4"></i>
                <h2 class="text-3xl font-black mb-2 uppercase w-full text-center">GAME OVER</h2>
                <p class="text-5xl font-black text-blue-400 mb-10 w-full text-center">${scr.score}</p>
                <button class="bg-yellow-600 px-10 py-3 rounded-full font-black shadow-lg text-gray-900 w-full mb-4" onclick="startScrambleGame()">Main Lagi</button>
                <button class="text-gray-500 font-bold w-full text-center" onclick="navigate('categories')">Keluar</button>
            </div>
        `;
    }

    let heartsHTML = Array(3).fill(0).map((_, i) => `
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="${i < scr.lives ? '#ef4444' : 'transparent'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${i < scr.lives ? 'text-red-500' : 'text-gray-700'}"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
    `).join('');

    let selectedHTML = scr.selected.map((s, i) => `
        <div onclick="handleRemoveScrambleChar(${i})" class="w-14 h-14 bg-yellow-600 rounded-2xl flex items-center justify-center font-black text-3xl shadow-xl cursor-pointer hover:bg-red-600 hover:scale-110 transition-all">${s.char}</div>
    `).join('');

    let scrambledHTML = scr.scrambled.map((char, i) => {
        const isUsed = scr.selected.some(s => s.idx === i);
        let classes = isUsed ? 'bg-gray-700 opacity-20 cursor-not-allowed' : 'bg-gray-600 hover:bg-yellow-500 hover:scale-110 active:scale-95 cursor-pointer';
        return `
            <button ${isUsed ? 'disabled' : ''} class="w-16 h-16 rounded-2xl font-black text-3xl transition-all shadow-xl ${classes}" onclick="handleScrambleChar('${char}', ${i})">${char}</button>
        `;
    }).join('');

    return `
        <div class="flex flex-col items-center w-full max-w-lg p-8 bg-gray-800 rounded-3xl border-2 border-yellow-500 shadow-2xl relative text-center">
            <div class="flex justify-between w-full mb-8 items-center px-2">
                <div class="font-black text-blue-400 text-2xl uppercase">Skor: ${scr.score}</div>
                <div class="flex gap-1 bg-black/30 p-2 rounded-full border border-white/5">${heartsHTML}</div>
            </div>
            <h2 class="text-2xl font-black text-yellow-500 mb-2 uppercase tracking-tighter italic w-full text-center">Word Scramble</h2>
            <p class="text-gray-400 mb-10 px-4 leading-relaxed w-full text-center">Susun Huruf Hiragana: <br/><span class="text-white font-black text-2xl italic">"${scr.target?.translation}"</span></p>
            
            <div class="flex flex-wrap gap-2 mb-4 h-auto min-h-[4rem] items-center justify-center border-b-4 border-gray-600 w-full p-2">
                ${selectedHTML}
            </div>
            <p class="text-[10px] text-gray-500 mb-8 uppercase font-bold w-full text-center">*Klik huruf di atas untuk menghapus</p>
            
            <div class="flex flex-wrap justify-center gap-4 mb-10">
                ${scrambledHTML}
            </div>
            <button class="text-gray-500 font-bold mt-4 w-full text-center" onclick="navigate('categories')">Keluar</button>
        </div>
    `;
}

// --- AI CHAT LOGIC ---

function toggleChat() {
    state.chatState.isOpen = !state.chatState.isOpen;
    renderChat();
}

async function handleSendMsg() {
    let inputEl = document.getElementById('ai-chat-input');
    let text = inputEl.value.trim();
    if(!text || state.chatState.isTyping) return;
    
    inputEl.value = '';
    state.chatState.messages.push({ role: 'user', text: text });
    state.chatState.isTyping = true;
    renderChat();
    
    const response = await fetchAIResponse(text, state.chatState.messages.slice(0, -1)); // exclude the latest user message from history for context if needed, but fetchAIResponse adds it anyway. Let's pass whole history.
    
    state.chatState.messages.push({ role: 'model', text: response });
    state.chatState.isTyping = false;
    renderChat();
}

function renderChat() {
    let chatDiv = document.getElementById('ai-chat-container');
    let cs = state.chatState;

    if(!cs.isOpen) {
        chatDiv.innerHTML = `
            <div class="fixed bottom-6 right-6 z-[100]">
                <button onclick="toggleChat()" class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center shadow-neon-blue hover:scale-110 active:scale-95 transition-all text-white animate-pulse-slow">
                    <i data-lucide="message-square" class="w-8 h-8"></i>
                </button>
            </div>
        `;
    } else {
        let msgHTML = cs.messages.map(msg => `
            <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[85%] p-3 rounded-[1.2rem] text-xs font-bold leading-relaxed ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none shadow-lg' : 'bg-gray-800 text-slate-200 rounded-tl-none border border-white/5 shadow-md'}">
                    ${msg.text}
                </div>
            </div>
        `).join('');

        let typingHTML = cs.isTyping ? `
            <div class="flex justify-start animate-pulse">
                <div class="bg-gray-800 text-slate-400 p-2 rounded-xl rounded-tl-none text-[10px] flex items-center gap-2">
                    <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Sensei sedang berpikir...
                </div>
            </div>
        ` : '';

        chatDiv.innerHTML = `
            <div class="fixed bottom-6 right-6 z-[100]">
                <div class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm pointer-events-auto">
                    <div class="bg-gray-900 border-2 border-blue-500 rounded-[2.5rem] w-[320px] sm:w-[350px] h-[480px] shadow-2xl flex flex-col overflow-hidden relative">
                        <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                            <div class="flex items-center gap-2 font-black uppercase text-xs tracking-wider">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Tanya Sensei AI
                            </div>
                            <button onclick="toggleChat()" class="hover:bg-blue-700 p-1 rounded-full transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div id="ai-chat-scroll" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-950 text-left">
                            ${msgHTML}
                            ${typingHTML}
                        </div>
                        <div class="p-4 bg-gray-900 border-t border-white/10 flex gap-2">
                            <input type="text" id="ai-chat-input" onkeypress="if(event.key === 'Enter') handleSendMsg()" placeholder="Ketik pertanyaan..." class="flex-1 bg-slate-800 border border-white/10 rounded-xl px-4 py-2 text-white text-xs focus:outline-none focus:border-blue-500 transition-all" />
                            <button onclick="handleSendMsg()" class="bg-blue-600 p-2 rounded-xl text-white hover:bg-blue-500 transition-all shadow-lg active:scale-90 flex items-center justify-center">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Auto scroll to bottom
        setTimeout(() => {
            let scrollEl = document.getElementById('ai-chat-scroll');
            if(scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
        }, 50);
    }
    lucide.createIcons();
}

// --- FUNGSI RENDER UTAMA ---
function renderApp() {
    let content = '';
    switch(state.page) {
        case 'home': content = renderHome(); break;
        case 'about': content = renderAbout(); break;
        case 'categories': content = renderCategories(); break;
        case 'subcategories': content = renderSubcategories(); break;
        case 'modeSelect': content = renderModeSelect(); break;
        case 'vocabList': content = renderVocabList(); break;
        case 'flashcards': content = renderFlashcards(); break;
        case 'quiz': content = renderQuiz(); break;
        case 'review': content = renderReview(); break;
        case 'gameMatch': content = renderGameMatch(); break;
        case 'gameSpeed': content = renderGameSpeed(); break;
        case 'gameScramble': content = renderGameScramble(); break;
    }
    
    // Animasi fade in sederhana untuk pergantian halaman
    appDiv.style.opacity = '0';
    appDiv.style.transform = 'scale(0.98)';
    
    setTimeout(() => {
        appDiv.innerHTML = content;
        appDiv.style.transition = 'all 0.3s ease-out';
        appDiv.style.opacity = '1';
        appDiv.style.transform = 'scale(1)';
        lucide.createIcons();
    }, 150);
}

// --- INISIALISASI ---
document.addEventListener('DOMContentLoaded', () => {
    renderApp();
    renderChat();
});

</script>
</body>
</html>
